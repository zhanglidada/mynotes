[[在图像的存储中，常用的两种格式]]
有nhwc喝nhwc两种数据存储格式。其中 N 表示这批图像有几张，H 表示图像在竖直方向有多少像素，W 表示水平方向像素数，C 表示通道数（例如黑白图像的通道数 C = 1，而 RGB 彩色图像的通道数
 C = 3）。为了便于演示，我们后面作图均使用 RGB 三通道图像。

###两种数据格式存储的区别：
![1](/assets/1.webp)

##NCHW：
在NCHW 中，数据排列顺序为 [batch, height, width, channels]；C 排列在外层，每个通道内像素紧挨在一起，即 'RRRRRRGGGGGGBBBBBB' 这种形式。
![2](/assets/2.webp)
在对图像进行灰度计算时，即 R 通道所有像素值乘以 0.299，G 通道所有像素值乘以 0.587，B 通道所有像素值乘以 0.114，最后将三个通道结果相加得到灰度值。
##NHWC
在NHWC 格式中，排列顺序为 [batch, channels, height, width]。C 排列在最内层，多个通道对应空间位置的像素紧挨在一起，即 'RGBRGBRGBRGBRGBRGB' 这种形式。
![3](/assets/3.webp)
输入数据分成多个(R, G, B) 像素组，每个像素组中 R 通道像素值乘以 0.299，G 通道像素值乘以 0.587，B 通道像素值乘以 0.114 后相加得到一个灰度输出像素。将多组结果拼接起来得到所有灰度输出像素。

###对比：
1). 使用两种数据格式进行 RGB -> 灰度计算的复杂度是相同的，区别在于访存特性。通过两张图对比可以发现，**NHWC 的访存局部性更好**（每三个输入像素即可得到一个输出像素），NCHW 则必须等所有
通道输入准备好才能得到最终输出结果，需要占用较大的临时空间。

2). **在 CNN 中常常见到 1x1 卷积**（例如：用于移动和嵌入式视觉应用的 MobileNets），也是每个输入 channel 乘一个权值，然后将所有 channel 结果累加得到一个输出 channel。如果使用 NHWC 数据格式，
可以将卷积计算简化为矩阵乘计算，即 1x1的卷积核实现了每个输入像素组到每个输出像素组的线性变换。

###最佳实践：
设计网络时充分考虑两种格式，最好能灵活切换，在 GPU 上训练时使用 NCHW 格式，在 CPU 上做预测时使用 NHWC 格式。
